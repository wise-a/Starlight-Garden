<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starlight Garden v1.1</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <h1>Starlight Garden</h1>
        <div class="controls">
            <button onclick="saveGame()">ðŸ’¾ Save Game (.txt)</button>
            <label for="loadInput" class="btn">ðŸ“‚ Load Game (.txt)</label>
            <input type="file" id="loadInput" accept=".txt" onchange="loadGame(this)">
        </div>
        
        <canvas id="gameCanvas" width="640" height="480"></canvas>
        
        <div class="hud">
            <p><strong>Arrow Keys</strong> to Move | <strong>Space</strong> to Plant/Water/Harvest</p>
            <div class="stats-bar">
                <span id="status">Seeds: 5 | Water: 10</span>
                <span id="score-display">Harvested: 0</span>
                <span id="regen-timer" style="color: #666; font-size: 0.8em;">(Water in: --)</span>
            </div>
        </div>
        <div id="message-area"></div>
    </div>

<script>
/**
 * GAME CONSTANTS & STATE
 */
const TILE_SIZE = 32;
const COLS = 20;
const ROWS = 15;

const COLORS = {
    0: '#2d4a3e', // Grass
    1: '#595652', // Rock
    2: '#4da6ff', // Water
    player: '#ffcc00', // Player
    plant_seed: '#8fbc8f',
    plant_bloom: '#ff99cc'
};

// Default State
let gameState = {
    meta: { version: "1.1", timestamp: Date.now() },
    player: { x: 1, y: 1, seeds: 5, water: 10, score: 0 },
    world: {
        width: COLS,
        height: ROWS,
        map: Array(ROWS).fill().map(() => Array(COLS).fill(0)), 
        plants: [] 
    }
};

// Water Regeneration Logic
let waterTimer = 0;
setInterval(() => {
    const p = gameState.player;
    
    // Determine required time based on rules
    // Rule 1: Have seeds? 15 seconds.
    // Rule 2: No seeds? 60 seconds.
    const threshold = (p.seeds > 0) ? 15 : 60;
    
    waterTimer++;
    
    // Visual countdown for the user
    const countdown = threshold - waterTimer;
    document.getElementById('regen-timer').innerText = `(Water in: ${countdown}s)`;

    if (waterTimer >= threshold) {
        p.water++;
        waterTimer = 0;
        updateHUD();
        // Optional: subtle message if you want it
        // showMessage("Water recovered."); 
    }
}, 1000);


// Setup Canvas
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Input Handling
document.addEventListener('keydown', (e) => {
    const p = gameState.player;
    if (e.key === 'ArrowUp') tryMove(p.x, p.y - 1);
    if (e.key === 'ArrowDown') tryMove(p.x, p.y + 1);
    if (e.key === 'ArrowLeft') tryMove(p.x - 1, p.y);
    if (e.key === 'ArrowRight') tryMove(p.x + 1, p.y);
    if (e.key === ' ') interact();
    draw();
});

/**
 * CORE LOGIC
 */
function tryMove(newX, newY) {
    if (newX < 0 || newX >= gameState.world.width || newY < 0 || newY >= gameState.world.height) return;
    
    const tile = gameState.world.map[newY][newX];
    if (tile === 1 || tile === 2) {
        showMessage("Blocked path.");
        return;
    }

    gameState.player.x = newX;
    gameState.player.y = newY;
}

function interact() {
    const p = gameState.player;
    const plants = gameState.world.plants;
    const plantIndex = plants.findIndex(pl => pl.x === p.x && pl.y === p.y);

    if (plantIndex !== -1) {
        // Plant exists here
        const plant = plants[plantIndex];
        
        if (plant.stage === 'seed') {
            // ACTION: Water the seed
            if (p.water > 0) {
                plant.stage = 'bloomed';
                p.water--;
                showMessage("You watered the seed. It bloomed!");
            } else {
                showMessage("Not enough water!");
            }
        } else if (plant.stage === 'bloomed') {
            // ACTION: Harvest the flower
            plants.splice(plantIndex, 1); // Remove plant
            p.seeds += 2; // Get 2 seeds
            p.score = (p.score || 0) + 1; // Increase score
            showMessage("Harvested! Got 2 Seeds.");
        }
    } else {
        // ACTION: Plant new seed
        if (p.seeds > 0) {
            gameState.world.plants.push({ x: p.x, y: p.y, stage: 'seed' });
            p.seeds--;
            showMessage("Planted a seed.");
        } else {
            showMessage("No seeds left!");
        }
    }
    updateHUD();
}

function updateHUD() {
    const p = gameState.player;
    // Ensure score exists if loading old save
    if (typeof p.score === 'undefined') p.score = 0; 
    
    document.getElementById('status').innerText = `Seeds: ${p.seeds} | Water: ${p.water}`;
    document.getElementById('score-display').innerText = `Harvested: ${p.score}`;
}

function showMessage(msg) {
    const el = document.getElementById('message-area');
    el.innerText = msg;
    // Clear message after 2 seconds
    setTimeout(() => {
        if(el.innerText === msg) el.innerText = "";
    }, 2000);
}

/**
 * RENDERING
 */
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw Map
    for (let y = 0; y < gameState.world.height; y++) {
        for (let x = 0; x < gameState.world.width; x++) {
            ctx.fillStyle = COLORS[gameState.world.map[y][x]];
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            ctx.strokeStyle = '#1a2e26';
            ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        }
    }

    // Draw Plants
    gameState.world.plants.forEach(plant => {
        ctx.fillStyle = plant.stage === 'seed' ? COLORS.plant_seed : COLORS.plant_bloom;
        // Make bloomed plants look bigger
        const offset = plant.stage === 'seed' ? 10 : 4;
        const size = plant.stage === 'seed' ? 12 : 24;
        ctx.fillRect(plant.x * TILE_SIZE + offset, plant.y * TILE_SIZE + offset, size, size);
    });

    // Draw Player
    ctx.fillStyle = COLORS.player;
    ctx.fillRect(gameState.player.x * TILE_SIZE + 8, gameState.player.y * TILE_SIZE + 8, 16, 16);
}

/**
 * SAVE / LOAD SYSTEM
 */
function saveGame() {
    const jsonString = JSON.stringify(gameState, null, 4);
    const blob = new Blob([jsonString], { type: "text/plain" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `starlight_save_${Date.now()}.txt`;
    link.click();
    showMessage("Game Saved!");
}

function loadGame(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const loadedState = JSON.parse(e.target.result);
            if (!loadedState.player || !loadedState.world) throw new Error("Invalid Save");
            
            gameState = loadedState;
            // Reset score if missing in old save
            if (typeof gameState.player.score === 'undefined') gameState.player.score = 0;
            
            draw();
            updateHUD();
            showMessage("Game Loaded!");
        } catch (err) {
            alert("Error loading save file.");
        }
    };
    reader.readAsText(file);
}

// Initial Draw
draw();
updateHUD();

</script>
</body>
</html>
